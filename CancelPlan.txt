USE [welcomgroup]
GO

/****** Object:  StoredProcedure [hotels].[SP_cancel_plan]    Script Date: 04/12/2016 19:45:57 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[hotels].[SP_cancel_plan]') AND type in (N'P', N'PC'))
DROP PROCEDURE [hotels].[SP_cancel_plan]
GO

USE [welcomgroup]
GO

/****** Object:  StoredProcedure [hotels].[SP_cancel_plan]    Script Date: 04/12/2016 19:45:57 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



-- =============================================
-- Description:	<To calculate the cancel amount>
-- =============================================
CREATE PROCEDURE [hotels].[SP_cancel_plan]
@bookingId numeric(18,0),
@result int output
AS
BEGIN
    Declare @planId numeric(18,0),@checkInDate varchar(20),@cancelDays numeric(18,0),@cancelType varchar(1),
    @roomId numeric(18,0),@checkOutDate varchar(20),@hotelId numeric(18,0)
    
    Select @planId = Plan_Id,@checkInDate=Checkin_Date,@checkOutDate=Checkout_Date,@roomId=Room_id,@hotelId=Hotel_id
    from dbo.ReservationDetails where Booking_Id = @bookingId
    
    Select @cancelDays=CancelDays,@cancelType=CancelType from b_plan where id_plan=@planId 
	
    if(DATEDIFF(DAY,convert(date,getdate()),convert(date,@checkInDate)) > 0 and @cancelType != 'C')
    begin
		if(DATEDIFF(DAY,convert(date,getdate()),convert(date,@checkInDate)) > @cancelDays)
		begin
		   SELECT @result = 1;
		   Select bp.CancelType, bp.CancelValue, bp.CancelDays,bp.CancelTime,bpr.amt_rspax1,bpr.amt_rspax2,
		   bp.DepositValue,bp.DiscountSign,bp.DiscountValue from b_plan bp 
		   inner join b_plan_rate bpr on bp.id_plan = bpr.id_plan where bp.id_plan=@planId and bpr.id_hotel=@hotelId and 
		   bpr.id_room = @roomId and date_startocc <= @checkInDate and date_endocc >= @checkOutDate  
		   
		   Select Amount_Paid,Number_Of_Rooms,Number_Of_Adults,Number_Of_Childrens,Total_Points_Deducted,
		   Siebel_TransactionId,Full_Green_Points,Half_Green_Points from dbo.ReservationDetails where Booking_Id = @bookingId 
		end
	    
		else if(DATEDIFF(DAY,convert(date,getdate()),convert(date,@checkInDate)) = @cancelDays)
		begin
		   SELECT @result = 2;
		   Select bp.CancelType, bp.CancelValue, bp.CancelDays,bp.CancelTime,bpr.amt_rspax1,bpr.amt_rspax2,
		   bp.DepositValue,bp.DiscountSign,bp.DiscountValue from b_plan bp 
		   inner join b_plan_rate bpr on bp.id_plan = bpr.id_plan where bp.id_plan=@planId and bpr.id_hotel=@hotelId and 
		   bpr.id_room = @roomId and date_startocc <= @checkInDate and date_endocc >= @checkOutDate 
		   
		   Select Amount_Paid,Number_Of_Rooms,Number_Of_Adults,Number_Of_Childrens,Total_Points_Deducted,
		   Siebel_TransactionId,Full_Green_Points,Half_Green_Points from dbo.ReservationDetails where Booking_Id = @bookingId
		end
		
		else
		begin
		   SELECT @result = 3;
		   Select bp.CancelType, bp.CancelValue, bp.CancelDays,bp.CancelTime,bpr.amt_rspax1,bpr.amt_rspax2,
		   bp.DepositValue,bp.DiscountSign,bp.DiscountValue from b_plan bp 
		   inner join b_plan_rate bpr on bp.id_plan = bpr.id_plan where bp.id_plan=@planId and bpr.id_hotel=@hotelId and 
		   bpr.id_room = @roomId and date_startocc <= @checkInDate and date_endocc >= @checkOutDate 
		   
		   Select Amount_Paid,Number_Of_Rooms,Number_Of_Adults,Number_Of_Childrens,Total_Points_Deducted,
		   Siebel_TransactionId,Full_Green_Points,Half_Green_Points from dbo.ReservationDetails where Booking_Id = @bookingId
		end
	end	
	else
	begin
	   SELECT @result = 4;   
	end
	Select @result as result;
    
END



GO


