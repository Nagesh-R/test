USE [welcomgroup]
GO
/****** Object:  StoredProcedure [hotels].[SP_GetFlexibleRates]    Script Date: 08/25/2016 17:35:32 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Description:	< To get the min rates for hotel 
--                  based on days >

-- =============================================
ALTER PROCEDURE [hotels].[SP_GetFlexibleRates] 
 @hotelId numeric(18,0),@startDate datetime,@endDate datetime,@noOfRooms int,@noOfPerson int
	
AS
BEGIN
declare @noOfDays int
declare @advDays int=0;
set @noOfDays = DATEDIFF(DAY,convert(date,@startDate),convert(date,@endDate))

	--Select bpr.amt_rspax1,bpr.amt_rspax2,bpr.amt_rspaxex,bpr.child_rspax1,convert(DATE,bpr.date_startocc) as date_startocc,
--	convert(DATE,bpr.date_endocc) as date_endocc,bp.DiscountSign,bp.DiscountValue,bp.Flg_avlday1,bp.Flg_avlday2,bp.Flg_avlday3,bp.Flg_avlday4,bp.Flg_avlday5,
--	bp.Flg_avlday6,bp.Flg_avlday7 From b_plan bp inner join b_plan_rate bpr on bp.id_plan = bpr.id_plan
--	where bp.id_hotel = @hotelId and bp.soft_delete = 'N' 
	
	---Modified statement for flexible rate--
	declare @tempCheckInDate datetime
	declare @tempCheckOutDate datetime
	set @tempCheckInDate = convert(DATE,@startDate)
	
	if(@noOfDays > 7)
	begin
	   set @tempCheckOutDate = DATEADD(DAY,7,@tempCheckInDate)
	end
	else
	begin
	   set @tempCheckOutDate = @endDate
	end
	
    CREATE TABLE #temp_room_rates
	(
	 curr_date varchar(20),Id_room numeric(18,0),
	 amt_rspax1 numeric(18,2),amt_rspax2 numeric(18,2),
	 Flg_avlday1 char(1),Flg_avlday2 char(1),Flg_avlday3 char(1),Flg_avlday4 char(1),Flg_avlday5 char(1),
	 Flg_avlday6 char(1),Flg_avlday7 char(1),Flg_arrday1 char(1),Flg_arrday2 char(1),Flg_arrday3 char(1),
	 Flg_arrday4 char(1),Flg_arrday5 char(1),Flg_arrday6 char(1),Flg_arrday7 char(1),
	 id_plan numeric(18,0),
	 No_avail int
	)
	
	while(@startDate < @endDate)
    begin
		INSERT INTO #temp_room_rates
		(
		 curr_date,Id_room,
	     amt_rspax1,amt_rspax2,
	     Flg_avlday1,Flg_avlday2,Flg_avlday3,Flg_avlday4,Flg_avlday5,
		 Flg_avlday6,Flg_avlday7,Flg_arrday1,Flg_arrday2,Flg_arrday3,
		 Flg_arrday4,Flg_arrday5,Flg_arrday6,Flg_arrday7,
		 id_plan,No_avail
		)
		select convert(DATE,@startDate),br.Id_room
	    ,case when bp.redemptionType = 'F' then bpr.points else bpr.amt_rspax1 end as amt_rspax1
	    ,case when bp.redemptionType = 'F' then bpr.points else bpr.amt_rspax2 end as amt_rspax2
		,bp.Flg_avlday1,bp.Flg_avlday2,bp.Flg_avlday3,bp.Flg_avlday4,bp.Flg_avlday5,
		bp.Flg_avlday6,bp.Flg_avlday7,bp.Flg_arrday1,bp.Flg_arrday2,bp.Flg_arrday3,
		bp.Flg_arrday4,bp.Flg_arrday5,bp.Flg_arrday6,bp.Flg_arrday7
		,bp.id_plan,bravail.No_avail
		from dbo.b_room br inner join dbo.b_room_avail bravail on br.Id_room=bravail.id_room
		inner join dbo.b_plan_rate bpr on br.Id_room=bpr.id_room 
		inner join dbo.b_plan bp on bpr.id_plan=bp.id_plan  
		where br.id_hotel=@hotelId and bravail.Date_avail = @startDate
		and bravail.Flg_status='O'
		and br.flg_sale='Y' and 
		bp.id_plan in (Select bp2.id_plan from b_plan_rate bpr2 inner join b_plan bp2 
		on bpr2.id_plan = bp2.id_plan inner join b_ratecategory brc on bp2.rate_code = brc.rate_code
		inner join b_ratecategory_date brd on brc.id_ratecategory = brd.id_ratecategory_date
		inner join b_planstatus bps on bp2.id_plan = bps.id_plan  
		where bp2.id_hotel = @hotelId and brd.Date_planstatus = convert(DATE,@startDate) and brd.Flg_openstatus = 'O'
		--and @noOfDays between bp2.no_minlos and bp2.no_maxlos
		 and bp2.flg_del = 'N' and bp2.soft_delete='N'
		and (bp2.promo_code is null or bp2.promo_code = '') and bps.Flg_openstatus = 'O' 
		and bps.Date_planstatus = @startDate
		union Select bp2.id_plan from b_plan_rate bpr2 inner join b_plan bp2 
		on bpr2.id_plan = bp2.id_plan inner join b_planstatus bps on bp2.id_plan = bps.id_plan 
		where bp2.id_hotel = @hotelId and bp2.DiscountValue is not null
		--and @noOfDays between bp2.no_minlos and bp2.no_maxlos
		 and bp2.flg_del = 'N' and bp2.soft_delete='N'
		and (bp2.promo_code is null or bp2.promo_code = '') and bps.Flg_openstatus = 'O' 
		and bps.Date_planstatus = @startDate
		-- and bp2.no_advdays <= @advDays
		union Select bp2.id_plan from b_plan_rate bpr2 inner join b_plan bp2 
		on bpr2.id_plan = bp2.id_plan inner join b_planstatus bps on bp2.id_plan = bps.id_plan
		where bp2.id_hotel = @hotelId and UPPER(bp2.rate_code) = 'NONE'
		--and @noOfDays between bp2.no_minlos and bp2.no_maxlos
		 and bp2.flg_del = 'N' and bp2.soft_delete='N'
		and (bp2.promo_code is null or bp2.promo_code = '') and bps.Flg_openstatus = 'O' 
		and bps.Date_planstatus = @startDate
		-- and bp2.no_advdays <= @advDays
		) 
	    order by amt_rspax1,amt_rspax2,amt_rspaxex ASC
	    
		set @startDate = DATEADD(day,1,@startDate)
    end
	--select * from #temp_room_rates
    set @startDate = @tempCheckInDate
    declare @YFlag varchar(1) = 'Y' 
    declare @columnStr varchar(300)=''
    declare @sql nvarchar(1000)
	declare @daystr varchar(20)=''
	declare @arrDayStr varchar(20)=''
	declare @arrDayCol varchar(50)=''
	set @arrDayStr = DATENAME(DW,@tempCheckInDate)
	
	
		if(@arrDayStr = 'Monday')
		begin 
		  set @arrDayCol = 'Flg_arrday1='''+@YFlag+''''
		end
		else if(@arrDayStr = 'Tuesday')
		begin 
		  set @arrDayCol = 'Flg_arrday2='''+@YFlag+''''
		end
		else if(@arrDayStr = 'Wednesday')
		begin 
		  set @arrDayCol = 'Flg_arrday3='''+@YFlag+''''
		end
		else if(@arrDayStr = 'Thursday')
		begin 
		  set @arrDayCol = 'Flg_arrday4='''+@YFlag+''''
		end
		else if(@arrDayStr = 'Friday')
		begin  
		  set @arrDayCol = 'Flg_arrday5='''+@YFlag+''''
		end
		else if(@arrDayStr = 'Saturday')
		begin 
		  set @arrDayCol = 'Flg_arrday6='''+@YFlag+''''
		end
		else if(@arrDayStr = 'Sunday')
		begin 
		  set @arrDayCol = 'Flg_arrday7='''+@YFlag+''''
		end
    
    while(@tempCheckInDate < CONVERT(DATE,@tempCheckOutDate))
    begin
		set @daystr = DATENAME(DW,@tempCheckInDate)
		
		if(@columnStr != '')
		begin
			set @columnStr = @columnStr + ' and '
		end
		if(@daystr = 'Monday')
		begin 
		  set @columnStr = @columnStr + 'Flg_avlday1='''+@YFlag+''''
		end
		else if(@daystr = 'Tuesday')
		begin 
		  set @columnStr = @columnStr + 'Flg_avlday2='''+@YFlag+''''
		end
		else if(@daystr = 'Wednesday')
		begin 
		  set @columnStr = @columnStr + 'Flg_avlday3='''+@YFlag+''''
		end
		else if(@daystr = 'Thursday')
		begin 
		  set @columnStr = @columnStr + 'Flg_avlday4='''+@YFlag+''''
		end
		else if(@daystr = 'Friday')
		begin  
		  set @columnStr = @columnStr + 'Flg_avlday5='''+@YFlag+''''
		end
		else if(@daystr = 'Saturday')
		begin 
		  set @columnStr = @columnStr + 'Flg_avlday6='''+@YFlag+''''
		end
		else if(@daystr = 'Sunday')
		begin 
		  set @columnStr = @columnStr + 'Flg_avlday7='''+@YFlag+''''
		end
		
		set @tempCheckInDate = DATEADD(day,1,@tempCheckInDate)
		 
    end
		set @sql = 'select min(amt_rspax1),min(amt_rspax2),id_room,curr_date,id_plan,No_avail
	     from #temp_room_rates where ' +@columnStr+' and '
		+@arrDayCol
		+' group by id_room,curr_date,id_plan,No_avail order by curr_date asc' 
		
	    create table #temp_min_rate_by_dates
	    (amt_rspax1 numeric(18,2),amt_rspax2 numeric(18,2),id_room numeric(18,0),
	     curr_date varchar(20),id_plan numeric(18,0),No_avail int
	    )
		
		INSERT INTO #temp_min_rate_by_dates
		(amt_rspax1,amt_rspax2,id_room,curr_date,id_plan,No_avail) 
	    
	    execute sp_executesql @sql
	    
	   select amt_rspax1 as amt_rspax1,amt_rspax2 as amt_rspax2,curr_date as rateDate,No_avail
	   ,id_plan,id_room from #temp_min_rate_by_dates where amt_rspax1 in 
	   (select MIN(amt_rspax1) from #temp_min_rate_by_dates where curr_date=curr_date)
	      
END
